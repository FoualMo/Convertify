{% extends "base.html" %}
{% block content %}

<section class="py-5 position-relative overflow-hidden">
  <div class="container text-center position-relative">

    <h2 class="mb-4 text-gradient">Compresseur de fichiers</h2>
    <p class="text-muted mb-4">Glissez un fichier ou cliquez pour sélectionner, puis choisissez le niveau de compression.</p>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form id="compress-form"
          action="{{ url_for('compress.compress_file') }}"
          method="POST"
          enctype="multipart/form-data"
          class="mx-auto p-4 rounded-4 shadow-lg bg-gradient-to-r from-indigo-900 to-indigo-800 text-light"
          style="max-width:500px;">

      <!-- ✅ DRAG & DROP -->
      <div id="drop-area" class="mb-3 p-4 border border-dashed rounded-3" style="cursor:pointer;">
        <p id="drop-text">Déposez un fichier ici ou cliquez</p>
        <input type="file" id="fileInput" name="file" hidden required>
      </div>

      <p id="file-name" class="small">Aucun fichier choisi</p>

      <!-- ✅ SLIDER -->
      <label for="compression-rate" class="form-label mt-3">
        Niveau de compression : <span id="compression-value">70</span>%
      </label>
      <input type="range"
             id="compression-rate"
             name="compression_rate"
             class="form-range"
             min="1" max="100" value="70">

      <button type="submit" class="btn btn-success w-100 py-2 mt-3">Compresser</button>
    </form>

    <!-- ✅ Loader -->
    <div id="loader" style="display:none; margin-top:25px;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Compression en cours...</p>
    </div>

    <!-- ✅ Succès -->
    <div id="success-feedback" style="display:none; margin-top:25px;">
      <p class="text-success fs-5">Compression réussie !</p>
      <a id="download-link" class="btn btn-primary">Télécharger le fichier</a>
    </div>

  </div>
</section>

<style>
#drop-area {
  background: rgba(255,255,255,0.1);
  border: 2px dashed #fff;
  transition: 0.3s;
}
#drop-area.hover {
  background: rgba(255,255,255,0.2);
  transform: scale(1.02);
}
</style>

<script>

const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('fileInput');
const fileNameDisplay = document.getElementById('file-name');

// Effets visuels
["dragenter", "dragover"].forEach(event => {
  dropArea.addEventListener(event, () => dropArea.classList.add("hover"));
});
["dragleave", "drop"].forEach(event => {
  dropArea.addEventListener(event, () => dropArea.classList.remove("hover"));
});

// Drop
dropArea.addEventListener("drop", e => {
  e.preventDefault();
  fileInput.files = e.dataTransfer.files;
  updateFileInfo();
});

// Click → Ouvrir
dropArea.addEventListener("click", () => fileInput.click());

// Sélection normale
fileInput.addEventListener("change", updateFileInfo);

function updateFileInfo() {
  fileNameDisplay.textContent =
    fileInput.files.length > 0
      ? fileInput.files[0].name
      : "Aucun fichier choisi";
}

// =======================
// FORM SUBMIT
// =======================
const form = document.getElementById('compress-form');
const loader = document.getElementById('loader');
const successFeedback = document.getElementById('success-feedback');
const downloadLink = document.getElementById('download-link');
const compressionSlider = document.getElementById('compression-rate');
const compressionValue = document.getElementById('compression-value');

// Slider affichage
compressionSlider.addEventListener("input", () => {
  compressionValue.textContent = compressionSlider.value;
});

form.addEventListener("submit", async e => {
  e.preventDefault();

  if (fileInput.files.length === 0) {
    alert("Veuillez choisir un fichier.");
    return;
  }

  loader.style.display = "block";
  successFeedback.style.display = "none";

  const formData = new FormData(form);

  try {
    const response = await fetch(form.action, {
      method: "POST",
      body: formData
    });

    if (!response.ok) throw new Error("Erreur lors de la compression");

    const blob = await response.blob();
    const url = URL.createObjectURL(blob);

    downloadLink.href = url;
    downloadLink.download =
      fileInput.files[0].name.split(".")[0] + "-compressed";

    loader.style.display = "none";
    successFeedback.style.display = "block";

  } catch (err) {
    loader.style.display = "none";
    alert("Erreur : " + err.message);
  }
});

</script>

{% endblock %}
